<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Place Order</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .category-btn { 
            width: 100%; 
            margin-bottom: 10px; 
        }
        .drinks-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .drink-btn {
            background: transparent;
            border: 1px solid #28a745;
            color: #28a745;
            width: 90%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: normal;
            word-break: break-word;
            padding: 0 5px;
        }
        .drinks-panel { 
            height: 500px; 
            overflow-y: auto; 
        }
        .order-summary { 
            height: 500px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 10px; 
        }
        .addons-panel { 
            margin-top: 20px; 
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .order-total {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #333;
        }
        .drink-item {
            background: #e9ecef;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px;
            text-align: center;
        }
        .addon-checkbox:checked + label {
            font-weight: bold;
            color: #28a745;
        }
        .receipt-modal .modal-content {
            border-radius: 15px;
            border: none;
        }
        .receipt-header {
            background: #28a745;
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px;
            text-align: center;
        }
        .receipt-body {
            padding: 25px;
        }
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        .receipt-total {
            font-weight: bold;
            font-size: 1.3em;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #333;
        }
        .success-animation {
            text-align: center;
            color: #28a745;
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
<div class="container-fluid mt-3">
    <h1>Place Order</h1>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="row">
        <!-- Left Panel: Categories -->
        <div class="col-2">
            <h4>Categories</h4>
            <div th:each="category : ${categories}">
                <button type="button" 
                        class="btn btn-outline-primary category-btn"
                        th:text="${category.categoryName}"
                        th:onclick="'loadDrinks(' + ${category.categoryId} + ')'"
                        ></button>
            </div>
        </div>

        <!-- Middle Panel: Drinks -->
        <div class="col-6">
            <h4>Drinks</h4>
            <div class="drinks-panel">
                <div class="drinks-container" id="drinks-container">
                    <div th:each="drink : ${drinks}" class="drink-item">
                        <button type="button"
                                class="btn btn-outline-success drink-btn"
                                th:text="${drink.drinkName}"
                                th:data-drink-id="${drink.drinkId}"
                                th:data-drink-price="${drink.basePrice}"
                                onclick="addToOrder(this)">
                        </button>
                        <div class="text-center mt-1" th:text="'₱' + ${drink.basePrice}"></div>
                    </div>
                </div>
            </div>

            <!-- Add-ons -->
            <div class="addons-panel">
                <h5>Add-ons</h5>
                <div class="row">
                    <div th:each="addon : ${addons}" class="col-md-4 mb-2">
                        <div class="form-check">
                            <input class="form-check-input addon-checkbox" type="checkbox" 
                                   th:value="${addon.addonId}" th:id="'addon-'+${addon.addonId}"
                                   th:data-addon-price="${addon.price}" 
                                   th:data-addon-name="${addon.addonName}"
                                   onchange="updateAddons()"/>
                            <label class="form-check-label" th:for="'addon-'+${addon.addonId}">
                                <span th:text="${addon.addonName}"></span> - ₱<span th:text="${addon.price}"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Order Summary -->
        <div class="col-4">
            <h4>Current Order</h4>
            <div class="order-summary" id="order-summary">
                <p class="text-center text-muted">No items yet</p>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <span class="order-total">Total: ₱<span id="order-total">0.00</span></span>
                <button class="btn btn-success" onclick="previewOrder()">Place Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Confirmation Modal -->
<div class="modal fade receipt-modal" id="receiptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="receipt-header">
                <h5 class="modal-title">Order Confirmation</h5>
            </div>
            <div class="receipt-body">
                <div id="receipt-content">
                    <!-- Receipt content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit Order</button>
                <button type="button" class="btn btn-success" onclick="confirmOrder()">Confirm Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Order Placed Successfully!</h3>
                <p>Your order has been received and is being prepared.</p>
                <div class="mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Continue Ordering</button>
                    <a href="/order/history" class="btn btn-success">View Order History</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentOrder = {
        items: [],
        addons: [],
        total: 0
    };

    function addToOrder(button) {
        const drinkId = button.getAttribute('data-drink-id');
        const drinkName = button.textContent;
        const drinkPrice = parseFloat(button.getAttribute('data-drink-price'));
        const quantity = 1;

        const existingItemIndex = currentOrder.items.findIndex(item => item.drinkId === drinkId);
        
        if (existingItemIndex >= 0) {
            currentOrder.items[existingItemIndex].quantity += 1;
        } else {
            currentOrder.items.push({ 
                drinkId, 
                drinkName, 
                drinkPrice,
                quantity 
            });
        }

        calculateTotal();
        renderOrder();
    }

    function updateAddons() {
        currentOrder.addons = [];
        
        document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
            const addonId = checkbox.value;
            const addonName = checkbox.getAttribute('data-addon-name');
            const addonPrice = parseFloat(checkbox.getAttribute('data-addon-price'));
            
            const existing = currentOrder.addons.find(a => a.addonId == addonId);
            if (existing) {
                existing.quantity += 1;
            } else {
                currentOrder.addons.push({ 
                    addonId, 
                    addonName, 
                    price: addonPrice,
                    quantity: 1
                });
            }
        });

        calculateTotal();
        renderOrder();
    }

    function calculateTotal() {
        let itemsTotal = currentOrder.items.reduce((total, item) => {
            return total + (item.drinkPrice * item.quantity);
        }, 0);
        
        let addonsTotal = currentOrder.addons.reduce((total, addon) => {
            return total + (addon.price * addon.quantity);
        }, 0);
        
        currentOrder.total = itemsTotal + addonsTotal;
        document.getElementById('order-total').textContent = currentOrder.total.toFixed(2);
    }

    function renderOrder() {
        const panel = document.getElementById('order-summary');
        
        if (currentOrder.items.length === 0 && currentOrder.addons.length === 0) {
            panel.innerHTML = '<p class="text-center text-muted">No items yet</p>';
            return;
        }
        
        let html = '';
        
        currentOrder.items.forEach(item => {
            html += `
                <div class="order-item">
                    <div>
                        <span>${item.drinkName} x${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="decrementItem(${item.drinkId})">-</button>
                        <button class="btn btn-sm btn-outline-success" onclick="incrementItem(${item.drinkId})">+</button>
                    </div>
                    <div>₱${(item.drinkPrice * item.quantity).toFixed(2)}</div>
                </div>
            `;
        });
        
        currentOrder.addons.forEach(addon => {
            html += `
                <div class="order-item">
                    <div>
                        <span>${addon.addonName} x${addon.quantity}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="decrementAddon(${addon.addonId})">-</button>
                        <button class="btn btn-sm btn-outline-success" onclick="incrementAddon(${addon.addonId})">+</button>
                    </div>
                    <div>₱${(addon.price * addon.quantity).toFixed(2)}</div>
                </div>
            `;
        });
        
        panel.innerHTML = html;
    }

    function incrementItem(drinkId) {
        const item = currentOrder.items.find(item => item.drinkId == drinkId);
        if (item) {
            item.quantity += 1;
            calculateTotal();
            renderOrder();
        }
    }

    function decrementItem(drinkId) {
        const itemIndex = currentOrder.items.findIndex(item => item.drinkId == drinkId);
        if (itemIndex >= 0) {
            const item = currentOrder.items[itemIndex];
            if (item.quantity > 1) {
                item.quantity -= 1;
            } else {
                currentOrder.items.splice(itemIndex, 1);
            }
            calculateTotal();
            renderOrder();
        }
    }

    function previewOrder() {
        if (currentOrder.items.length === 0 && currentOrder.addons.length === 0) {
            alert('Please add items to your order first!');
            return;
        }

        // Prepare data for the preview
        const drinkIds = currentOrder.items.map(i => i.drinkId);
        const quantities = currentOrder.items.map(i => i.quantity);
        const addonIds = currentOrder.addons.map(a => a.addonId);

        // Create form data
        const formData = new FormData();
        formData.append('drinkIds', drinkIds.join(','));
        formData.append('quantities', quantities.join(','));
        formData.append('addonIds', addonIds.join(','));

        // Send request to get order summary
        fetch('/order/preview', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Display the receipt in the modal
            displayReceipt(data);
            
            // Show the modal
            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            receiptModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating receipt. Please try again.');
        });
    }

    function displayReceipt(orderSummary) {
        const receiptContent = document.getElementById('receipt-content');
        let html = `
            <h6 class="text-center mb-4">COMMONBREW COFFEE SHOP</h6>
            <p class="text-center">Order #${Math.floor(1000 + Math.random() * 9000)}</p>
            <p class="text-center">${new Date().toLocaleString()}</p>
            <hr>
            <div class="mb-3">
        `;

        // Add items
        if (orderSummary.items && orderSummary.items.length > 0) {
            orderSummary.items.forEach(item => {
                html += `
                    <div class="receipt-item">
                        <div>${item.name} x${item.quantity}</div>
                        <div>₱${item.price.toFixed(2)}</div>
                    </div>
                `;
            });
        }

        // Add addons
        if (orderSummary.addons && orderSummary.addons.length > 0) {
            html += `<div class="mt-3"><strong>Add-ons:</strong></div>`;
            orderSummary.addons.forEach(addon => {
                html += `
                    <div class="receipt-item">
                        <div>${addon.name} x${addon.quantity}</div>
                        <div>₱${addon.price.toFixed(2)}</div>
                    </div>
                `;
            });
        }

        // Add total
        html += `
            </div>
            <hr>
            <div class="receipt-item receipt-total">
                <div>TOTAL</div>
                <div>₱${orderSummary.total.toFixed(2)}</div>
            </div>
            <p class="text-center mt-4">Thank you for your order!</p>
        `;

        receiptContent.innerHTML = html;
    }

    function confirmOrder() {
        // Prepare data for submission
        const drinkIds = currentOrder.items.map(i => i.drinkId);
        const quantities = currentOrder.items.map(i => i.quantity);
        const addonIds = currentOrder.addons.map(a => a.addonId);

        // Create form data
        const formData = new FormData();
        formData.append('drinkIds', drinkIds.join(','));
        formData.append('quantities', quantities.join(','));
        formData.append('addonIds', addonIds.join(','));

        // Submit the order
        fetch('/order/submit', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(result => {
            if (result === 'success') {
                // Close the receipt modal
                const receiptModal = bootstrap.Modal.getInstance(document.getElementById('receiptModal'));
                receiptModal.hide();
                
                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
                // Reset the order
                currentOrder = { items: [], addons: [], total: 0 };
                calculateTotal();
                renderOrder();
            } else {
                alert('Error placing order. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error placing order. Please try again.');
        });
    }

    function loadDrinks(categoryId) {
        fetch('/order/drinks/' + categoryId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(drinks => {
                const container = document.getElementById('drinks-container');
                container.innerHTML = '';

                if (drinks.length === 0) {
                    container.innerHTML = '<p class="text-center">No drinks available in this category</p>';
                    return;
                }

                drinks.forEach(drink => {
                    const drinkItem = document.createElement('div');
                    drinkItem.className = 'drink-item';
                    
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-success drink-btn';
                    btn.textContent = drink.drinkName;
                    btn.dataset.drinkId = drink.drinkId;
                    btn.dataset.drinkPrice = drink.basePrice;
                    btn.onclick = function() { addToOrder(this); };
                    
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'text-center mt-1';
                    priceDiv.textContent = '₱' + drink.basePrice;
                    
                    drinkItem.appendChild(btn);
                    drinkItem.appendChild(priceDiv);
                    container.appendChild(drinkItem);
                });
            })
            .catch(err => {
                console.error('Error loading drinks:', err);
                const container = document.getElementById('drinks-container');
                container.innerHTML = '<p class="text-center">Error loading drinks. Please try again.</p>';
            });
    }

    function incrementAddon(addonId) {
        const addon = currentOrder.addons.find(a => a.addonId == addonId);
        if (addon) {
            addon.quantity += 1;
            calculateTotal();
            renderOrder();
        }
    }

    function decrementAddon(addonId) {
        const index = currentOrder.addons.findIndex(a => a.addonId == addonId);
        if (index >= 0) {
            const addon = currentOrder.addons[index];
            if (addon.quantity > 1) {
                addon.quantity -= 1;
            } else {
                currentOrder.addons.splice(index, 1);
                const checkbox = document.getElementById('addon-' + addonId);
                if (checkbox) checkbox.checked = false;
            }
            calculateTotal();
            renderOrder();
        }
    }
    
    // Load drinks from the first category when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const firstCategoryButton = document.querySelector('.category-btn');
        if (firstCategoryButton) {
            const onclickAttr = firstCategoryButton.getAttribute('onclick');
            const categoryId = onclickAttr.match(/\d+/)[0];
            loadDrinks(categoryId);
        }
        
        document.querySelectorAll('.addon-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateAddons);
        });
    });
</script>
</body>
</html>