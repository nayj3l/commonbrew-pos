<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Place Order</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        /* Your existing styles remain unchanged */
        .category-btn { 
            width: 100%; 
            margin-bottom: 10px; 
        }
        .drinks-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .drink-btn {
            background: transparent;
            border: 1px solid #28a745;
            color: #28a745;
            width: 90%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: normal;
            word-break: break-word;
            padding: 0 5px;
        }
        .drinks-panel { 
            height: 500px; 
            overflow-y: auto; 
        }
        .order-summary { 
            height: 500px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 10px; 
        }
        .addons-panel { 
            margin-top: 20px; 
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .order-total {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #333;
        }
        .drink-item {
            background: #e9ecef;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px;
            text-align: center;
        }
        .addon-checkbox:checked + label {
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-3">
    <h1>Place Order</h1>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="row">
        <!-- Left Panel: Categories -->
        <div class="col-2">
            <h4>Categories</h4>
            <div th:each="category : ${categories}">
                <button type="button" 
                        class="btn btn-outline-primary category-btn"
                        th:text="${category.categoryName}"
                        th:onclick="'loadDrinks(' + ${category.categoryId} + ')'"
                        ></button>
            </div>
        </div>

        <!-- Middle Panel: Drinks -->
        <div class="col-6">
            <h4>Drinks</h4>
            <div class="drinks-panel">
                <div class="drinks-container" id="drinks-container">
                    <!-- Drinks buttons will be rendered here via JS -->
                    <div th:each="drink : ${drinks}" class="drink-item">
                        <button type="button"
                                class="btn btn-outline-success drink-btn"
                                th:text="${drink.drinkName}"
                                th:data-drink-id="${drink.drinkId}"
                                th:data-drink-price="${drink.basePrice}"
                                onclick="addToOrder(this)">
                        </button>
                        <div class="text-center mt-1" th:text="'₱' + ${drink.basePrice}"></div>
                    </div>
                </div>
            </div>

            <!-- Add-ons -->
            <div class="addons-panel">
                <h5>Add-ons</h5>
                <div class="row">
                    <div th:each="addon : ${addons}" class="col-md-4 mb-2">
                        <div class="form-check">
                            <input class="form-check-input addon-checkbox" type="checkbox" 
                                   th:value="${addon.addonId}" th:id="'addon-'+${addon.addonId}"
                                   th:data-addon-price="${addon.price}" 
                                   th:data-addon-name="${addon.addonName}"
                                   onchange="updateAddons()"/>
                            <label class="form-check-label" th:for="'addon-'+${addon.addonId}">
                                <span th:text="${addon.addonName}"></span> - ₱<span th:text="${addon.price}"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Order Summary -->
        <div class="col-4">
            <h4>Current Order</h4>
            <div class="order-summary" id="order-summary">
                <p class="text-center text-muted">No items yet</p>
            </div>

            <form id="order-form" method="post" th:action="@{/order/confirm}" class="d-flex justify-content-between mt-3">
                <!-- Hidden inputs to send order data -->
                <input type="hidden" name="drinkIds" id="drinkIds">
                <input type="hidden" name="quantities" id="quantities">
                <input type="hidden" name="addonIds" id="addonIds">
                <input type="hidden" name="addonQuantities" id="addonQuantities">

                <span class="order-total">Total: ₱<span id="order-total">0.00</span></span>
                <button class="btn btn-success" type="button" onclick="confirmOrder()">Place Order</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Example JS for adding drinks to the order panel
    let currentOrder = {
        items: [],
        addons: [],
        total: 0
    };

    function addToOrder(button) {
        const drinkId = button.getAttribute('data-drink-id');
        const drinkName = button.textContent;
        const drinkPrice = parseFloat(button.getAttribute('data-drink-price'));
        const quantity = 1; // default, can add input later

        // Check if this drink is already in the order
        const existingItemIndex = currentOrder.items.findIndex(item => item.drinkId === drinkId);
        
        if (existingItemIndex >= 0) {
            // Increment quantity if already exists
            currentOrder.items[existingItemIndex].quantity += 1;
        } else {
            // Add new drink to order
            currentOrder.items.push({ 
                drinkId, 
                drinkName, 
                drinkPrice,
                quantity 
            });
        }

        calculateTotal();
        renderOrder();
    }

    function updateAddons() {
        // Clear current addons
        currentOrder.addons = [];
        
        // Get all checked addons
        document.querySelectorAll('.addon-checkbox:checked').forEach(checkbox => {
            const addonId = checkbox.value;
            const addonName = checkbox.getAttribute('data-addon-name');
            const addonPrice = parseFloat(checkbox.getAttribute('data-addon-price'));
            
            const existing = currentOrder.addons.find(a => a.addonId == addonId);
            if (existing) {
                existing.quantity += 1;
            } else {
                currentOrder.addons.push({ 
                    addonId, 
                    addonName, 
                    price: addonPrice,
                    quantity: 1  // add quantity field
                });
            }
        });

        calculateTotal();
        renderOrder();
    }

    function calculateTotal() {
        // Calculate items total
        let itemsTotal = currentOrder.items.reduce((total, item) => {
            return total + (item.drinkPrice * item.quantity);
        }, 0);
        
        // Calculate addons total
        let addonsTotal = currentOrder.addons.reduce((total, addon) => {
            return total + (addon.price * addon.quantity);
        }, 0);
        
        currentOrder.total = itemsTotal + addonsTotal;
        document.getElementById('order-total').textContent = currentOrder.total.toFixed(2);
    }

    function renderOrder() {
        const panel = document.getElementById('order-summary');
        
        if (currentOrder.items.length === 0 && currentOrder.addons.length === 0) {
            panel.innerHTML = '<p class="text-center text-muted">No items yet</p>';
            return;
        }
        
        let html = '';
        
        // Render drink items
        currentOrder.items.forEach(item => {
            html += `
                <div class="order-item">
                    <div>
                        <span>${item.drinkName} x${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="decrementItem(${item.drinkId})">-</button>
                        <button class="btn btn-sm btn-outline-success" onclick="incrementItem(${item.drinkId})">+</button>
                    </div>
                    <div>₱${(item.drinkPrice * item.quantity).toFixed(2)}</div>
                </div>
            `;
        });
        
        // Render addons
        currentOrder.addons.forEach(addon => {
            html += `
                <div class="order-item">
                    <div>
                        <span>${addon.addonName} x${addon.quantity}</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="decrementAddon(${addon.addonId})">-</button>
                        <button class="btn btn-sm btn-outline-success" onclick="incrementAddon(${addon.addonId})">+</button>
                    </div>
                    <div>₱${(addon.price * addon.quantity).toFixed(2)}</div>
                </div>
            `;
        });
        
        panel.innerHTML = html;
    }

    function incrementItem(drinkId) {
        const item = currentOrder.items.find(item => item.drinkId == drinkId);
        if (item) {
            item.quantity += 1;
            calculateTotal();
            renderOrder();
        }
    }

    function decrementItem(drinkId) {
        const itemIndex = currentOrder.items.findIndex(item => item.drinkId == drinkId);
        if (itemIndex >= 0) {
            const item = currentOrder.items[itemIndex];
            if (item.quantity > 1) {
                item.quantity -= 1;
            } else {
                currentOrder.items.splice(itemIndex, 1);
            }
            calculateTotal();
            renderOrder();
        }
    }

    // NEW FUNCTION: Confirm order before submission
    function confirmOrder() {
        if (currentOrder.items.length === 0 && currentOrder.addons.length === 0) {
            alert('No items in the order!');
            return;
        }

        // Show confirmation dialog
        if (confirm('Are you sure you want to place this order?')) {
            // Drinks
            document.getElementById('drinkIds').value = currentOrder.items.map(i => i.drinkId).join(',');
            document.getElementById('quantities').value = currentOrder.items.map(i => i.quantity).join(',');

            // Addons (IDs + quantities)
            document.getElementById('addonIds').value = currentOrder.addons.map(a => a.addonId).join(',');
            document.getElementById('addonQuantities').value = currentOrder.addons.map(a => a.quantity).join(',');

            document.getElementById('order-form').submit();
        }
    }

    function loadDrinks(categoryId) {
        fetch('/order/drinks/' + categoryId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(drinks => {
                const container = document.getElementById('drinks-container');
                container.innerHTML = ''; // clear existing buttons

                if (drinks.length === 0) {
                    container.innerHTML = '<p class="text-center">No drinks available in this category</p>';
                    return;
                }

                drinks.forEach(drink => {
                    const drinkItem = document.createElement('div');
                    drinkItem.className = 'drink-item';
                    
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-success drink-btn';
                    btn.textContent = drink.drinkName;
                    btn.dataset.drinkId = drink.drinkId;
                    btn.dataset.drinkPrice = drink.basePrice;
                    btn.onclick = function() { addToOrder(this); };
                    
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'text-center mt-1';
                    priceDiv.textContent = '₱' + drink.basePrice;
                    
                    drinkItem.appendChild(btn);
                    drinkItem.appendChild(priceDiv);
                    container.appendChild(drinkItem);
                });
            })
            .catch(err => {
                console.error('Error loading drinks:', err);
                const container = document.getElementById('drinks-container');
                container.innerHTML = '<p class="text-center">Error loading drinks. Please try again.</p>';
            });
    }

    function incrementAddon(addonId) {
        const addon = currentOrder.addons.find(a => a.addonId == addonId);
        if (addon) {
            addon.quantity += 1;
            calculateTotal();
            renderOrder();
        }
    }

    function decrementAddon(addonId) {
        const index = currentOrder.addons.findIndex(a => a.addonId == addonId);
        if (index >= 0) {
            const addon = currentOrder.addons[index];
            if (addon.quantity > 1) {
                addon.quantity -= 1;
            } else {
                currentOrder.addons.splice(index, 1);
                // Also uncheck the checkbox if quantity goes to 0
                const checkbox = document.getElementById('addon-' + addonId);
                if (checkbox) checkbox.checked = false;
            }
            calculateTotal();
            renderOrder();
        }
    }

    
    // Load drinks from the first category when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const firstCategoryButton = document.querySelector('.category-btn');
        if (firstCategoryButton) {
            const onclickAttr = firstCategoryButton.getAttribute('onclick');
            const categoryId = onclickAttr.match(/\d+/)[0];
            loadDrinks(categoryId);
        }
        
        // Add event listeners to addon checkboxes
        document.querySelectorAll('.addon-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateAddons);
        });
    });
</script>
</body>
</html>